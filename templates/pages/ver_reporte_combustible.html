{% extends 'layouts/base.html' %}
{% load static %}

{% block extrastyle %}
<style>
    .iframe-container {
        display: flex;
        width: 100%;
        height: 100%;
        flex-direction: column;
        overflow: hidden;
    }
    .parent-fit {
        flex-grow: 1;
        border: none;
        margin: 0;
        padding: 0;
        height: 100vh;
    }
    .table-container {
        margin-top: 20px;
    }
    .observaciones {
        white-space: pre-wrap;  /* Permitir saltos de línea */
        word-wrap: break-word;   /* Ajustar palabras largas */
    }
</style>
{% endblock extrastyle %}

{% block content %}
<div class="container">
    <h1>Ver Reporte de Combustible</h1>

    <!-- Filtros adicionales -->
    <form method="GET" action="">
        <div class="row">
            <div class="col-md-4 mb-3">
                <label for="fecha_inicio">Fecha Inicio:</label>
                <input type="date" name="fecha_inicio" class="form-control" value="{{ request.GET.fecha_inicio }}">
            </div>
            <div class="col-md-4 mb-3">
                <label for="fecha_fin">Fecha Fin:</label>
                <input type="date" name="fecha_fin" class="form-control" value="{{ request.GET.fecha_fin }}">
            </div>

            <!-- Filtro por Tipo de Combustible -->
            <div class="col-md-4 mb-3">
                <label for="combustible">Tipo de Combustible:</label>
                <input type="text" name="combustible" class="form-control" value="{{ request.GET.combustible }}">
            </div>

            <!-- Filtro por Código de Estación -->
            <div class="col-md-4 mb-3">
                <label for="codigo_estacion">Código de Estación:</label>
                <input type="text" name="codigo_estacion" class="form-control" value="{{ request.GET.codigo_estacion }}">
            </div>

            <!-- Filtro por Empresa -->
            <div class="col-md-4 mb-3">
                <label for="empresa">Empresa:</label>
                <input type="text" name="empresa" class="form-control" value="{{ request.GET.empresa }}">
            </div>

            <!-- Filtro por Centro de Costo -->
            <div class="col-md-4 mb-3">
                <label for="centro_costo">Centro de Costo:</label>
                <input type="text" name="centro_costo" class="form-control" value="{{ request.GET.centro_costo }}">
            </div>

            <!-- Filtro por Destino -->
            <div class="col-md-4 mb-3">
                <label for="destino">Destino:</label>
                <input type="text" name="destino" class="form-control" value="{{ request.GET.destino }}">
            </div>

            <!-- Filtro por Conductor -->
            <div class="col-md-4 mb-3">
                <label for="conductor">Conductor:</label>
                <input type="text" name="conductor" class="form-control" value="{{ request.GET.conductor }}">
            </div>

            <div class="col-md-4 mb-3 align-self-end">
                <button type="submit" class="btn btn-primary">Filtrar</button>
            </div>
        </div>
    </form>

    <!-- Tabla de botones -->
    <div class="table-container mb-3">
        <table class="table table-borderless">
            <tr>
                <td>
                    <form method="GET" action="{% url 'generar_pdf_combustible' %}">
    <input type="hidden" name="fecha_inicio" value="{{ request.GET.fecha_inicio }}">
    <input type="hidden" name="fecha_fin" value="{{ request.GET.fecha_fin }}">
    <button type="submit" class="btn btn-warning">Descargar PDF de Reporte de Combustible</button>
</form>
                </td>
                <td>
                    <button type="button" class="btn btn-danger" id="ocultar-seleccionados-btn">Archivar Seleccionados</button>
                </td>
            </tr>
        </table>
    </div>

    <!-- Tabla de reporte de combustible -->
    <div class="table-container">
        <table class="table table-striped table-bordered">
            <thead>
                <tr>
                    <th><input type="checkbox" id="select_all" /></th>
                    <th>Fecha</th>
                    <th>Combustible</th>
                    <th>Cantidad (galones)</th>
                    <th>Código Estación</th>
                    <th>Empresa</th>
                    <th>Centro de Costo</th>
                    <th>Destino</th>
                    <th>Conductor</th>
                    <th>Placa</th>
                    <th>Archivo</th>
                </tr>
            </thead>
            <tbody>
                {% for item in reportes %}
                <tr id="reporte-{{ item.id }}">
                    <td><input type="checkbox" name="reporte_ids" value="{{ item.id }}"></td>
                    <td>{{ item.fecha }}</td>
                    <td>{{ item.combustible }}</td>
                    <td>{{ item.cantidad }}</td>
                    <td>{{ item.codigo_estacion }}</td>
                    <td>{{ item.empresa }}</td>
                    <td>{{ item.centro_costo }}</td>
                    <td>{{ item.destino }}</td>
                    <td>{{ item.conductor }}</td>
                    <td>{{ item.placa }}</td>
                    <td>
    {% if item.id %}
        <a href="{% url 'generar_pdf_combustible2' item.id %}" class="btn btn-info" target="_blank">Descargar PDF</a>
    {% else %}
        No disponible
    {% endif %}
</td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="10" class="text-center">No se encontraron registros.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Paginación -->
    <div class="pagination">
        <span class="step-links">
            {% if reportes.has_previous %}
                <a href="?page=1">&laquo; Primera</a>
                <a href="?page={{ reportes.previous_page_number }}">Anterior</a>
            {% endif %}

            <span class="current">
                Página {{ reportes.number }} de {{ reportes.paginator.num_pages }}.
            </span>

            {% if reportes.has_next %}
                <a href="?page={{ reportes.next_page_number }}">Siguiente</a>
                <a href="?page={{ reportes.paginator.num_pages }}">Última &raquo;</a>
            {% endif %}
        </span>
    </div>
</div>

<script src="{% static 'js/bootstrap.bundle.min.js' %}"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    // Seleccionar todos los checkboxes
    document.getElementById('select_all').addEventListener('change', function() {
        let checkboxes = document.querySelectorAll('input[name="reporte_ids"]');
        for (let checkbox of checkboxes) {
            checkbox.checked = this.checked;
        }
    });

    // Ocultar registros seleccionados mediante AJAX
    document.getElementById('ocultar-seleccionados-btn').addEventListener('click', function() {
        let seleccionados = [];
        document.querySelectorAll('input[name="reporte_ids"]:checked').forEach((checkbox) => {
            seleccionados.push(checkbox.value);
        });

        if (seleccionados.length === 0) {
            alert("No has seleccionado ningún registro.");
            return;
        }

        // Petición AJAX para ocultar registros seleccionados
        $.ajax({
            url: "{% url 'ocultar_diario' %}",
            method: "POST",
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            },
            data: {
                "reporte_ids": seleccionados.join(",")
            },
            success: function(response) {
                if (response.success) {
                    seleccionados.forEach(id => {
                        $('#reporte-' + id).fadeOut();  // Ocultar las filas seleccionadas
                    });
                } else {
                    alert(response.error || "Error al ocultar los registros seleccionados.");
                }
            },
            error: function() {
                alert("Ocurrió un error al intentar ocultar los registros seleccionados.");
            }
        });
    });
</script>

{% endblock content %}

