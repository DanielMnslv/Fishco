{% extends 'layouts/base.html' %}
{% load static %}

{% block extrastyle %}
<style>
    .iframe-container {
        display: flex;
        width: 100%;
        height: 100%;
        flex-direction: column;
        overflow: hidden;
    }
    .parent-fit {
        flex-grow: 1;
        border: none;
        margin: 0;
        padding: 0;
        height: 100vh;
    }
    .table-container {
        margin-top: 20px;
    }
</style>
{% endblock extrastyle %}

{% block content %}
<div class="container">
    <h1>Ver Anticipos</h1>
    

    <form method="GET" action="">
        <div class="row">
            <div class="col-md-4 mb-3">
                <label for="fecha_inicio">Fecha Inicio:</label>
                <input type="date" name="fecha_inicio" class="form-control" value="{{ request.GET.fecha_inicio }}">
            </div>
            <div class="col-md-4 mb-3">
                <label for="fecha_fin">Fecha Fin:</label>
                <input type="date" name="fecha_fin" class="form-control" value="{{ request.GET.fecha_fin }}">
            </div>
            <div class="col-md-4 mb-3 align-self-end">
                <button type="submit" class="btn btn-primary">Filtrar</button>
            </div>
        </div>
    </form>
    <!-- Formulario separado para generar PDF -->
    <form method="GET" action="{% url 'generar_pdf_anticipos_aprobados' %}">
        <input type="hidden" name="fecha_inicio" value="{{ request.GET.fecha_inicio }}">
        <input type="hidden" name="fecha_fin" value="{{ request.GET.fecha_fin }}">
        <button type="submit" class="btn btn-warning mb-3">Descargar PDF de Anticipos Aprobados</button>
    </form>
    </div>
    <!-- Botón para aprobar todos los anticipos filtrados -->
    <form method="POST" action="{% url 'aprobar_anticipos_masivamente' %}">
        {% csrf_token %}
        <button type="submit" class="btn btn-success mb-3">Aprobar todos los anticipos Seleccionados</button>

        <!-- Tabla de resultados -->
        <div class="table-container">
            <table class="table table-striped table-bordered">
    <thead>
        <tr>
            <th>
                <input type="checkbox" id="select_all" /> <!-- Checkbox para seleccionar todos -->
            </th>
            <th>ID</th>
            <th>Fecha</th>
            <th>Centro de Costo</th>
            <th>NIT</th>
            <th>Nombre</th>
            <th>Producto/Servicio</th>
            <th>Cantidad</th>
            <th>Subtotal</th>
            <th>IVA</th>
            <th>Retención</th>
            <th>Total a Pagar</th>
            <th>Observaciones</th>
            <th>Aprobado</th>
            <th>Acciones</th> <!-- Nueva columna para acciones -->
        </tr>
    </thead>
    <tbody>
        {% for item in anticipos %}
        <tr id="anticipo-{{ item.id }}">
            <td><input type="checkbox" name="anticipo_ids" value="{{ item.id }}" checked></td>
            <td>{{ item.id }}</td>
            <td>{{ item.fecha|date:"Y-m-d" }}</td>
            <td>{{ item.centro_costo }}</td>
            <td>{{ item.nit }}</td>
            <td>{{ item.nombre }}</td>
            <td>{{ item.producto_servicio }}</td>
            <td>{{ item.cantidad }}</td>
            <td>{{ item.subtotal }}</td>
            <td>{{ item.valor_iva }}</td>
            <td>{{ item.valor_retencion }}</td>
            <td>{{ item.total_pagar }}</td>
            <td>{{ item.observaciones }}</td>
            <td>
                {% if item.aprobado %}
                    <span class="btn btn-success">Aprobado</span>
                {% else %}
                    <span class="btn btn-primary">Pendiente</span>
                {% endif %}
            </td>
            <td>
                <button class="btn btn-danger" onclick="ocultarAnticipo({{ item.id }})">Facturado y Archivado</button>
            </td>
        </tr>
        {% empty %}
        <tr>
            <td colspan="14" class="text-center">No se encontraron registros.</td>
        </tr>
        {% endfor %}
    </tbody>
</table>

        </div>
    </form>
</div>

<script src="{% static 'js/bootstrap.bundle.min.js' %}"></script>

<!-- Script para seleccionar todos los checkboxes -->
<script>
document.getElementById('select_all').addEventListener('change', function() {
    let checkboxes = document.querySelectorAll('input[name="anticipo_ids"]');
    for (let checkbox of checkboxes) {
        checkbox.checked = this.checked;
    }
});
</script>
<script>
    function ocultarAnticipo(id) {
    if (!id) {
        console.error("ID de anticipo no encontrado");
        return;
    }

    $.ajax({
        url: "/ocultar_anticipo/" + id + "/",
        method: "POST",
        headers: {
            'X-CSRFToken': '{{ csrf_token }}'  // Asegúrate de incluir el token CSRF para solicitudes POST
        },
        success: function(response) {
            $('#anticipo-' + id).hide();  // Ocultar la fila de la tabla
        },
        error: function(xhr, status, error) {
            console.error("Error ocultando anticipo: ", error);
        }
    });
}
</script>

{% endblock content %}
